pipeline {
    agent any

    environment {
        GITHUB_REPO            = "https://github.com/Khalil0010/Administration.git"
        DOCKER_REGISTRY        = "aziz244"
        IMAGE_TAG              = "1.0"
        KUBECONFIG_CREDENTIALS = "kubeconfig-id"
        NAMESPACE              = "savewise"
        TRIVY_PATH             = "${WORKSPACE}\\trivy-bin\\trivy.exe"
    }

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', url: "${GITHUB_REPO}"
            }
        }

        stage('Prepare Trivy') {
            steps {
                script {
                    // Check if Trivy already exists
                    def trivyExists = bat(script: '@if exist "%WORKSPACE%\\trivy-bin\\trivy.exe" (echo YES) else (echo NO)', returnStdout: true).trim()
                    
                    if (trivyExists.contains('NO')) {
                        echo "Trivy not found, downloading and installing..."
                        bat '''
                            @echo off
                            if exist trivy-bin rmdir /s /q trivy-bin
                            mkdir trivy-bin
                            cd trivy-bin
                            
                            echo Downloading Trivy...
                            curl -Lo trivy.zip https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Windows-64bit.zip
                            
                            if not exist trivy.zip (
                                echo ERROR: Failed to download Trivy!
                                exit /b 1
                            )
                            
                            echo Extracting Trivy...
                            tar -xf trivy.zip
                            del trivy.zip
                            
                            if not exist trivy.exe (
                                echo ERROR: trivy.exe not found after extraction!
                                exit /b 1
                            )
                            
                            echo Trivy installed successfully!
                            trivy.exe --version
                        '''
                    } else {
                        echo "Trivy already installed at ${WORKSPACE}\\trivy-bin\\trivy.exe"
                        bat "\"${WORKSPACE}\\trivy-bin\\trivy.exe\" --version"
                    }
                }
            }
        }

        // ========== BUILD STAGES ==========
        stage('Build: Analytics Service') {
            steps {
                dir('analytics-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/analytics-service:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: Auth Service') {
            steps {
                dir('auth-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/auth-service:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: Budget Service') {
            steps {
                dir('budget-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/budget-service:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: Frontend') {
            steps {
                dir('frontend') {
                    bat "docker build -t ${DOCKER_REGISTRY}/frontend:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: Notification Service') {
            steps {
                dir('notification-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/notification-service:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: Saving Goals Service') {
            steps {
                dir('saving-goals-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/saving-goals-service:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: Transaction Service') {
            steps {
                dir('transaction-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/transaction-service:${IMAGE_TAG} ."
                }
            }
        }

        stage('Build: User Service') {
            steps {
                dir('user-service') {
                    bat "docker build -t ${DOCKER_REGISTRY}/user-service:${IMAGE_TAG} ."
                }
            }
        }

        // ========== TRIVY SCAN STAGES ==========
        stage('Scan: Analytics Service') {
            steps {
                script {
                    echo "Scanning analytics-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/analytics-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in analytics-service"
                        // Uncomment the next line to fail the pipeline on vulnerabilities
                        // error("Trivy scan failed for analytics-service")
                    } else {
                        echo "‚úÖ Trivy scan completed for analytics-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: Auth Service') {
            steps {
                script {
                    echo "Scanning auth-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/auth-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in auth-service"
                    } else {
                        echo "‚úÖ Trivy scan completed for auth-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: Budget Service') {
            steps {
                script {
                    echo "Scanning budget-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/budget-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in budget-service"
                    } else {
                        echo "‚úÖ Trivy scan completed for budget-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: Frontend') {
            steps {
                script {
                    echo "Scanning frontend..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/frontend:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in frontend"
                    } else {
                        echo "‚úÖ Trivy scan completed for frontend - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: Notification Service') {
            steps {
                script {
                    echo "Scanning notification-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/notification-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in notification-service"
                    } else {
                        echo "‚úÖ Trivy scan completed for notification-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: Saving Goals Service') {
            steps {
                script {
                    echo "Scanning saving-goals-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/saving-goals-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in saving-goals-service"
                    } else {
                        echo "‚úÖ Trivy scan completed for saving-goals-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: Transaction Service') {
            steps {
                script {
                    echo "Scanning transaction-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/transaction-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in transaction-service"
                    } else {
                        echo "‚úÖ Trivy scan completed for transaction-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        stage('Scan: User Service') {
            steps {
                script {
                    echo "Scanning user-service..."
                    def scanStatus = bat(script: """
                        @echo off
                        "${TRIVY_PATH}" image --exit-code 1 --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/user-service:${IMAGE_TAG}
                    """, returnStatus: true)
                    
                    if (scanStatus != 0) {
                        echo "‚ö†Ô∏è Trivy found HIGH or CRITICAL vulnerabilities in user-service"
                    } else {
                        echo "‚úÖ Trivy scan completed for user-service - No HIGH/CRITICAL vulnerabilities"
                    }
                }
            }
        }

        // ========== PUSH STAGES ==========
        stage('Push: Analytics Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/analytics-service:${IMAGE_TAG}"
            }
        }

        stage('Push: Auth Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/auth-service:${IMAGE_TAG}"
            }
        }

        stage('Push: Budget Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/budget-service:${IMAGE_TAG}"
            }
        }

        stage('Push: Frontend') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/frontend:${IMAGE_TAG}"
            }
        }

        stage('Push: Notification Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/notification-service:${IMAGE_TAG}"
            }
        }

        stage('Push: Saving Goals Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/saving-goals-service:${IMAGE_TAG}"
            }
        }

        stage('Push: Transaction Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/transaction-service:${IMAGE_TAG}"
            }
        }

        stage('Push: User Service') {
            steps {
                bat "docker push ${DOCKER_REGISTRY}/user-service:${IMAGE_TAG}"
            }
        }

        // ========== KUBERNETES DEPLOYMENT ==========
        stage('Deploy to Kubernetes') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    script {
                        bat 'kubectl apply -f k8s\\namespace.yaml'
                    }
                }
            }
        }

        stage('Deploy: Analytics Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\analytics-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\analytics-service\\service.yaml"
                }
            }
        }

        stage('Deploy: Auth Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\auth-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\auth-service\\service.yaml"
                }
            }
        }

        stage('Deploy: Budget Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\budget-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\budget-service\\service.yaml"
                }
            }
        }

        stage('Deploy: Frontend') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\frontend\\deployment.yaml"
                    bat "kubectl apply -f k8s\\frontend\\service.yaml"
                }
            }
        }

        stage('Deploy: Notification Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\notification-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\notification-service\\service.yaml"
                }
            }
        }

        stage('Deploy: Saving Goals Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\saving-goals-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\saving-goals-service\\service.yaml"
                }
            }
        }

        stage('Deploy: Transaction Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\transaction-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\transaction-service\\service.yaml"
                }
            }
        }

        stage('Deploy: User Service') {
            steps {
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG')]) {
                    bat "kubectl apply -f k8s\\user-service\\deployment.yaml"
                    bat "kubectl apply -f k8s\\user-service\\service.yaml"
                }
            }
        }

        // ========== SMOKE TESTS ==========
        stage('Smoke Test: Auth Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://auth-service:8000/health"
                        echo "‚úÖ auth-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: auth-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: User Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://user-service:8001/health"
                        echo "‚úÖ user-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: user-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: Transaction Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://transaction-service:8002/health"
                        echo "‚úÖ transaction-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: transaction-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: Budget Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://budget-service:8003/health"
                        echo "‚úÖ budget-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: budget-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: Saving Goals Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://saving-goals-service:8004/health"
                        echo "‚úÖ saving-goals-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: saving-goals-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: Analytics Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://analytics-service:8005/health"
                        echo "‚úÖ analytics-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: analytics-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: Notification Service') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://notification-service:8006/health"
                        echo "‚úÖ notification-service is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: notification-service unreachable"
                    }
                }
            }
        }

        stage('Smoke Test: Frontend') {
            steps {
                script {
                    try {
                        bat "curl -sSf --max-time 20 http://frontend:8501"
                        echo "‚úÖ frontend is healthy"
                    } catch (Exception e) {
                        error "‚ùå Smoke test failed: frontend unreachable"
                    }
                }
            }
        }
    }

    post {
        success { echo "Pipeline succeeded! üöÄ" }
        failure { echo "Pipeline failed! Check logs. ‚ùå" }
    }
}