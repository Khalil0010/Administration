pipeline {
    agent any
    environment {
        GITHUB_REPO = "https://github.com/AzizSoftware/Administration.git"
        DOCKER_REGISTRY = "aziz244"
        NAMESPACE = "savewise"
        KUBECONFIG_CREDENTIALS = "kubeconfig-id"
    }

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', url: "${env.GITHUB_REPO}"
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    def services = ['analytics-service', 'auth-service', 'budget-service', 
                                    'frontend', 'notification-service', 'saving-goals-service', 
                                    'transaction-service', 'user-service']
                    services.each { svc ->
                        dir("${svc}") {
                            // If Jenkins is on Windows, use 'bat'. If Linux, use 'sh'
                            sh "python -m venv venv"
                            sh "./venv/bin/pip install --upgrade pip" // Linux path
                            sh "./venv/bin/pip install -r requirements.txt"
                        }
                    }
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    def services = ['analytics-service', 'auth-service', 'budget-service', 
                                    'frontend', 'notification-service', 'saving-goals-service', 
                                    'transaction-service', 'user-service']
                    services.each { svc ->
                        sh "docker build -t ${DOCKER_REGISTRY}/${svc}:1.0 ./${svc}"
                    }
                }
            }
        }

        stage('Run Trivy Scan') {
            steps {
                script {
                    def services = ['analytics-service', 'auth-service', 'budget-service', 
                                    'frontend', 'notification-service', 'saving-goals-service', 
                                    'transaction-service', 'user-service']
                    services.each { svc ->
                        echo "Scanning ${svc}..."
                        // Note: Ensure Trivy is installed on the Jenkins agent
                        sh "trivy image --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/${svc}:1.0"
                    }
                }
            }
        }

        stage('Push & Deploy') {
            steps {
                withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS}", variable: 'KUBECONFIG')]) {
                    script {
                        def services = ['analytics-service', 'auth-service', 'budget-service', 
                                        'frontend', 'notification-service', 'saving-goals-service', 
                                        'transaction-service', 'user-service']
                        
                        sh 'kubectl apply -f k8s/namespace.yaml'
                        
                        services.each { svc ->
                            sh "docker push ${DOCKER_REGISTRY}/${svc}:1.0"
                            sh "kubectl apply -f k8s/${svc}/deployment.yaml"
                            sh "kubectl apply -f k8s/${svc}/service.yaml"
                        }
                    }
                }
            }
        }
    }
}